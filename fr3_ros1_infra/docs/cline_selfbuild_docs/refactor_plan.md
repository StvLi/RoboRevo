# 机器人侧客户端重构计划

## 项目背景
重构具身项目robotics infra的机器人侧客户端。当前teleop_infer_infra包只有占位符实现，需要实际功能实现。

## 当前状态分析
- `teleop_infer_infra`包包含：
  - `EquilibriumPose.msg`：自定义消息定义
  - Python模块：`teleop.py`, `inference.py`, `utils.py`（均为占位符）
  - 缺少实际功能实现
- 依赖：`rospy`, `geometry_msgs`, `std_msgs`, `sensor_msgs`
- 与`franka_ros`包集成，但设计为独立

## 重构目标
1. **实现核心遥操作功能**
   - 机器人状态监控
   - 均衡位姿发布
   - 安全限制和边界检查
   - 交互式标记支持

2. **实现模型推理接口**
   - 模型加载和管理
   - 推理服务封装
   - 结果处理和转换

3. **改进代码架构**
   - 模块化设计，分离关注点
   - 清晰的接口定义
   - 可配置的参数管理
   - 全面的错误处理

4. **添加工具和实用程序**
   - 配置管理
   - 日志记录和监控
   - 数据转换工具
   - 测试工具

5. **增强文档和示例**
   - API文档
   - 使用示例
   - 部署指南

## 具体实施步骤

### 阶段1：基础架构重构
1. 重构`utils.py`：添加通用工具函数
   - 坐标转换工具（基于scipy.spatial.transform.Rotation）
   - ROS消息处理（PoseStamped, FrankaState等）
   - 配置加载（ROS参数服务器和YAML文件）
   - 日志记录工具（分级日志，统计信息）

2. 重构`teleop.py`：实现遥操作核心功能
   - `TeleopAgent`类：基于Haption6DExpert设计，管理遥操作设备输入
   - `RobotEnv`类：基于SimplifiedFrankaEnv设计，管理机器人状态和控制
   - `TeleopInterface`类：基于ExpEnvInteract设计，协调Agent和Env交互
   - 支持时钟回调机制（固定频率控制）

3. 重构`inference.py`：实现推理接口
   - `InferenceClient`类：基于RobotInferenceClient设计，管理推理服务器交互
   - 支持HTTP REST API，Base64图像编码，Receding Horizon策略
   - 动作解析和坐标转换（Local Frame到World Frame）

### 阶段2：集成和统一接口
4. 创建统一控制接口
   - `UnifiedController`类：支持遥操作和推理两种模式
   - 运行时模式切换（通过ROS参数或按钮控制）
   - 状态管理和模式同步

5. 添加配置和启动文件
   - ROS参数配置（服务器地址、频率、模式等）
   - 启动文件（支持不同配置的启动）
   - 配置文件模板（YAML格式）

6. 创建示例脚本
   - 纯遥操作示例（基于之前的interface.py）
   - 纯推理示例（基于之前的infer_umi.py）
   - 混合模式示例（遥操作和推理切换）

### 阶段3：测试和优化
7. 编写测试
   - 单元测试（工具函数、坐标转换等）
   - 集成测试（Agent-Env交互、服务器通信）
   - ROS节点测试（完整功能测试）

8. 性能优化和文档
   - 性能分析（实时性、内存使用）
   - 代码优化（减少计算开销，提高效率）
   - 详细文档（API文档、使用教程、架构说明）

## 技术决策
- **Python版本**：Python 3（与ROS1兼容）
- **代码风格**：遵循PEP 8，添加类型提示
- **错误处理**：使用自定义异常，详细日志
- **配置管理**：使用ROS参数服务器和YAML文件
- **测试框架**：使用`unittest`和`rostest`

## 预期成果
1. 功能完整的机器人侧客户端包
2. 清晰的模块化架构
3. 全面的测试覆盖
4. 详细的文档和示例
5. 易于扩展和维护的代码库

## 风险评估和缓解
- **风险**：与现有franka_ros包兼容性问题
  **缓解**：保持消息兼容性，进行充分集成测试
- **风险**：实时性能问题
  **缓解**：性能分析和优化，使用高效的数据结构
- **风险**：代码复杂度增加
  **缓解**：保持模块化设计，清晰的接口定义

## 时间估计
- 阶段1：2-3天
- 阶段2：1-2天  
- 阶段3：1天
- 总计：4-6天开发时间
